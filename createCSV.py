import json
import pandas as pd
import re

def cleanData(data):
    noSpace = []
    line = [i.replace('\n  ',"") for i in data]
    noSpace = [x.strip(' ') for x in line]
    line1 = [i.replace("[ ", "")for i in noSpace]
    line2 = [i.replace(" ", "")for i in line1]
    line3 = [i.replace(",", "'\r\n'")for i in line2]
    stringify = "\r\n".join(line3)
    return stringify

def getData():
    dataFrame = pd.DataFrame(columns=["Hash", "AnalysisDate","modulesLoaded", "mutexesCreated", "mutexesOpened", "registryKeysSet", "callsHighlighted", "processes_terminated", "ipTraffic"])
    with open("final_dataset.txt", 'r') as file:
        for hash in file:
            with open(str(hash).rstrip() + '.json', 'r') as access_json:
                access_jsone = json.load(access_json)
                prettyJSON = json.dumps(access_jsone, indent=4, separators=(',', ': '), sort_keys=True)
                analysisDate =  r'"last_modification_date":\s(\d\s*){10}' 
                analysisDateData = re.findall(analysisDate, prettyJSON)
                modulesLoaded = r'"modules_loaded"\s*:\s\[([^]]+)\s]'
                modulesLoadedData = re.findall(modulesLoaded, prettyJSON)
                mutexesCreated = r'"mutexes_created"\s*:\s\[([^]]+)\s]'
                mutexesCreatedData = re.findall(mutexesCreated, prettyJSON)
                mutexesOpened = r'"mutexes_opened"\s*:\s\[([^]]+)\s]'
                mutexesOpenedData = re.findall(mutexesOpened, prettyJSON)
                registryKeysSet = r'"registry_keys_set"\s*:\s\[([^]]+)\s]'
                registryKeysSetData = re.findall(registryKeysSet, prettyJSON)
                callsHighlighted = r'"calls_highlighted"\s*:\s\[([^]]+)\s]'
                callsHighlightedData = re.findall(callsHighlighted, prettyJSON)
                processesTerminated = r'processes_terminated"\s*:\s\[([^]]+)\s]'
                processesTerminatedData = re.findall(processesTerminated, prettyJSON)
                ipTraffic = r'"ip_traffic"\s*:\s\[([^]]+)\s]'
                ipTrafficData = re.findall(ipTraffic, prettyJSON)
                cleanModulesLoadedData = cleanData(modulesLoadedData)
                cleanMutexesCreatedData = cleanData(mutexesCreatedData)
                cleanaMutexesOpenedData = cleanData(mutexesOpenedData)
                cleanRegistryKeysSetData = cleanData(registryKeysSetData)
                cleanCallsHighlightedData = cleanData(callsHighlightedData)
                cleanProcessesTerminatedData = cleanData(processesTerminatedData)
                cleanipTrafficData = cleanData(ipTrafficData)
                data = {"Hash" : hash,
                        "AnalysisDate" : analysisDateData,
                        "modulesLoaded" : cleanModulesLoadedData,
                        "mutexesCreated" : cleanMutexesCreatedData,
                        "mutexesOpened" : cleanaMutexesOpenedData,
                        "registryKeysSet" : cleanRegistryKeysSetData,
                        "callsHighlighted" : cleanCallsHighlightedData,
                        "processes_terminated" : cleanProcessesTerminatedData,
                        "ipTraffic" : cleanipTrafficData
                        }
                
                dataFrame.loc[len(dataFrame)] = data
                print(dataFrame)
    dataFrame.to_csv('list.csv',index=False)


    
def main():
    getData()

main()
