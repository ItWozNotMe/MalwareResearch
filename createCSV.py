import json
import pandas as pd
import re
from textwrap import wrap
import time
import datetime

def cleanData(data):
    noSpace = []
    line = [i.replace('\n  ',"") for i in data]
    noSpace = [x.strip(' ') for x in line]
    line1 = [i.replace("[ ", "")for i in noSpace]
    line2 = [i.replace(" ", "")for i in line1]
    line3 = [i.replace(",", "'\r\n'")for i in line2]
    stringify = "\r\n".join(line3)
    return stringify


def cleanDate(data):
    cleanDate = []
    for item in data:
        if item not in cleanDate:
            cleanDate.append(item)
    return cleanDate[:1]

def formatDate(data):
    try:
        timeString = data[0]
        timestamp = int(timeString)
        dtObject = datetime.datetime.fromtimestamp(timestamp)
        return dtObject
    except:
        pass
    
def getData():
    dataFrame = pd.DataFrame(columns=["Hash", "AnalysisDate","modulesLoaded", "mutexesCreated", "mutexesOpened", "callsHighlighted",
                                      "processes_terminated", "ipTraffic","registryKeysSet"])
    
    with open("final_dataset.txt", 'r') as file:
        for hash in file:
            with open(str(hash).rstrip() + '.json', 'r') as access_json:
                access_jsone = json.load(access_json)
                prettyJSON = json.dumps(access_jsone, indent=4, separators=(',', ': '), sort_keys=True)
                analysisDate =  r'"analysis_date":\s*(\d+)'
                analysisDateData = re.findall(analysisDate, prettyJSON)
                modulesLoaded = r'"modules_loaded"\s*:\s\[([^]]+)\s]'
                modulesLoadedData = re.findall(modulesLoaded, prettyJSON)
                mutexesCreated = r'"mutexes_created"\s*:\s\[([^]]+)\s]'
                mutexesCreatedData = re.findall(mutexesCreated, prettyJSON)
                mutexesOpened = r'"mutexes_opened"\s*:\s\[([^]]+)\s]'
                mutexesOpenedData = re.findall(mutexesOpened, prettyJSON)
                registryKeysSet = r'"registry_keys_set"\s*:\s\[([^]]+)\s]'
                registryKeysSetData = re.findall(registryKeysSet, prettyJSON)
                callsHighlighted = r'"calls_highlighted"\s*:\s\[([^]]+)\s]'
                callsHighlightedData = re.findall(callsHighlighted, prettyJSON)
                processesTerminated = r'processes_terminated"\s*:\s\[([^]]+)\s]'
                processesTerminatedData = re.findall(processesTerminated, prettyJSON)
                ipTraffic = r'"ip_traffic"\s*:\s\[([^]]+)\s]'
                ipTrafficData = re.findall(ipTraffic, prettyJSON)
                cleanAnalysisDateData = cleanDate(analysisDateData)
                cleanModulesLoadedData = cleanData(modulesLoadedData)
                cleanMutexesCreatedData = cleanData(mutexesCreatedData)
                cleanaMutexesOpenedData = cleanData(mutexesOpenedData)
                cleanCallsHighlightedData = cleanData(callsHighlightedData)
                cleanProcessesTerminatedData = cleanData(processesTerminatedData)
                cleanipTrafficData = cleanData(ipTrafficData)
                cleanRegistryKeysSetData1 = cleanData(registryKeysSetData)
                formattedDate = formatDate(cleanAnalysisDateData)
                
                if len(cleanRegistryKeysSetData1) > 7000:
                    cleanRegistryKeysSetData1 = "Manual Check!"
                else:
                    pass
                if len(cleanipTrafficData) > 7000:
                    cleanipTrafficData = "Manual Check!"
                else:
                    pass
                data = {"Hash" : hash,
                        "AnalysisDate" : formattedDate,
                        "modulesLoaded" : cleanModulesLoadedData,
                        "mutexesCreated" : cleanMutexesCreatedData,
                        "mutexesOpened" : cleanaMutexesOpenedData,
                        "callsHighlighted" : cleanCallsHighlightedData,
                        "processes_terminated" : cleanProcessesTerminatedData,
                        "ipTraffic" : cleanipTrafficData,
                        "registryKeysSet" : cleanRegistryKeysSetData1,

                        }

                
                
                dataFrame.loc[len(dataFrame)] = data
    dataFrame.to_csv('list1.csv',index=False)



    
def main():
    getData()

main()

